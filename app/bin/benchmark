#!/usr/bin/env ruby
# frozen_string_literal: true

require "optparse"
require "json"
require "open3"
require_relative "../lib/core/dataset_loader"
require_relative "../lib/core/benchmark_runner"
require_relative "../lib/core/algorithm_registry"

class BenchmarkCLI
  SPINNER = %w[⠋ �⠙ �⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏].freeze

  def initialize
    @algorithm = nil
    @file = nil
    @target = nil
    @js = false
    @compare = false
    @verbose = false
  end

  def parse
    parser = OptionParser.new do |opts|
      opts.banner = "Usage: #{$0} --algorithm <name> --file <path> [--target <value>] [--js] [--compare]"

      opts.on("--algorithm NAME", "Algorithm to run (required)") do |name|
        @algorithm = name
      end

      opts.on("--file PATH", "Path to JSON dataset (required)") do |path|
        @file = path
      end

      opts.on("--target VALUE", "Target value for search algorithms") do |value|
        @target = value
      end

      opts.on("--js", "Run JavaScript implementation") do
        @js = true
      end

      opts.on("--compare", "Compare Ruby vs JavaScript implementations") do
        @compare = true
      end

      opts.on("--verbose", "Show progress indicators") do
        @verbose = true
      end

      opts.on("-h", "--help", "Show this help") do
        puts opts
        puts "\nAvailable algorithms:"
        AlgorithmRegistry.list.each { |a| puts "  - #{a}" }
        puts "\nFlags:"
        puts "  --js       Run JavaScript implementation"
        puts "  --compare  Run both Ruby and JS, show comparison"
        puts "  --verbose  Show progress indicators"
        exit
      end
    end
    parser.parse!

    raise "Missing --algorithm" unless @algorithm
    raise "Missing --file" unless @file
    raise "Unknown algorithm: #{@algorithm}" unless AlgorithmRegistry.exists?(@algorithm)

    self
  end

  def spin(message)
    return yield unless @verbose

    thread = Thread.new { sleep 0.1 while true }
    i = 0
    print "\r#{SPINNER[i]} #{message}"
    i = (i + 1) % SPINNER.length
    result = yield
  ensure
    thread.kill
    print "\r#{' ' * 50}\r"
    result
  end

  def run_ruby
    data = DatasetLoader.load(@file)
    algo = AlgorithmRegistry.get(@algorithm)
    args = @target ? [@target.to_i] : []

    result = spin("Running #{@algorithm} (Ruby)...") do
      BenchmarkRunner.run(algo, data, *args)
    end

    {
      language: "ruby",
      algorithm: @algorithm,
      dataset_size: data.length,
      result: result[:result],
      time_seconds: result[:time],
      memory_mb: result[:memory]
    }
  end

  def run_js
    data = DatasetLoader.load(@file)
    json_data = JSON.generate(data)
    is_searching = @algorithm.include?("search")
    is_ai = @algorithm == "k_means" || @algorithm == "simulated_annealing" || @algorithm == "genetic_algorithm"

    algo_require = is_searching ? "searching" : (is_ai ? @algorithm : "sorting")

    cmd = "node -e \""
    cmd += "const { #{@algorithm} } = require('./js/lib/algorithms/#{algo_require}');"
    cmd += "const { runBenchmark } = require('./js/lib/core/benchmark_runner');"
    cmd += "const data = #{json_data};"
    cmd += is_searching ? "runBenchmark('#{@algorithm}', data, #{@target});" : "runBenchmark('#{@algorithm}', data);"
    cmd += "\""

    spin("Running #{@algorithm} (JavaScript)...") do
      stdout, stderr, status = Open3.capture3(cmd)
      raise "JS Error: #{stderr}" unless status.success?
      JSON.parse(stdout)
    end
  end

  def run
    if @compare
      ruby_result = run_ruby
      js_result = run_js

      comparison = {
        ruby: ruby_result,
        js: js_result,
        comparison: {
          time_ratio: js_result["time_seconds"] / ruby_result[:time_seconds],
          faster: js_result["time_seconds"] < ruby_result[:time_seconds] ? "js" : "ruby"
        }
      }
      puts JSON.pretty_generate(comparison)
    elsif @js
      puts JSON.pretty_generate(run_js)
    else
      puts JSON.pretty_generate(run_ruby)
    end
  end
end

BenchmarkCLI.new.parse.run
